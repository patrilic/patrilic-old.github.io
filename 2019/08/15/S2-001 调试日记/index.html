<!DOCTYPE html><html lang="zh-CN"><head><meta name="generator" content="Hexo 3.8.0"><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>S2-001 调试日记 | Patrilic's blog</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/normalize/8.0.1/normalize.min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//lib.baomitu.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//lib.baomitu.com/jquery/3.4.0/jquery.min.js"></script><link rel="icon" mask sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">S2-001 调试日记</h1><a id="logo" href="/.">Patrilic's blog</a><p class="description">不忘初心</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/2019/04/01/Hello/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">S2-001 调试日记</h1><div class="post-meta">Aug 15, 2019<span> | </span><span class="category"><a href="/categories/漏洞复现/">漏洞复现</a></span><script src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> 阅读</span></span></div><a class="disqus-comment-count" data-disqus-identifier="2019/08/15/S2-001 调试日记/" href="/2019/08/15/S2-001 调试日记/#disqus_thread"></a><div class="clear"><div class="toc-article" id="toc"><div class="toc-title">文章目录</div><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#0x00-前言"><span class="toc-number">1.</span> <span class="toc-text">0x00 前言</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x01-漏洞链接"><span class="toc-number">2.</span> <span class="toc-text">0x01 漏洞链接</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x02-环境搭建"><span class="toc-number">3.</span> <span class="toc-text">0x02 环境搭建</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x03-OGNL表达式"><span class="toc-number">4.</span> <span class="toc-text">0x03 OGNL表达式</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#基本概念"><span class="toc-number">4.1.</span> <span class="toc-text">基本概念</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Ognl表达式语言的作用"><span class="toc-number">4.2.</span> <span class="toc-text">Ognl表达式语言的作用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#OGNL-的基本语法"><span class="toc-number">4.3.</span> <span class="toc-text">OGNL 的基本语法</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x04-漏洞验证"><span class="toc-number">5.</span> <span class="toc-text">0x04 漏洞验证</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x05-漏洞分析"><span class="toc-number">6.</span> <span class="toc-text">0x05 漏洞分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x06-总结"><span class="toc-number">7.</span> <span class="toc-text">0x06 总结</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x07-链接"><span class="toc-number">8.</span> <span class="toc-text">0x07 链接</span></a></li></ol></div></div><div class="post-content"><blockquote>
<p>@ Author: Patrilic<br>@ Time: 2019-8-15 02:11:50<br><img src="/wallpaper/[33861]❊-52241977.png" alt></p>
</blockquote>
<h2 id="0x00-前言"><a href="#0x00-前言" class="headerlink" title="0x00 前言"></a>0x00 前言</h2><p>太菜了，马上进入大三了，最近java的中间件也陆陆续续的爆了很多洞，然后之前也经常接触类似于Weblogic反序列化、struts2命令执行之类的漏洞。借着重刷了一遍Fate Stay Night 06版，睡不着觉，干脆就来开始人生中第一个S2漏洞分析</p>
<h2 id="0x01-漏洞链接"><a href="#0x01-漏洞链接" class="headerlink" title="0x01 漏洞链接"></a>0x01 漏洞链接</h2><p><a href="https://cwiki.apache.org/confluence/display/WW/S2-001" target="_blank" rel="noopener">https://cwiki.apache.org/confluence/display/WW/S2-001</a><br>影响版本：</p>
<blockquote>
<p>WebWork 2.1 (with altSyntax enabled), WebWork 2.2.0 - WebWork 2.2.5, Struts 2.0.0 - Struts 2.0.8</p>
</blockquote>
<h2 id="0x02-环境搭建"><a href="#0x02-环境搭建" class="headerlink" title="0x02 环境搭建"></a>0x02 环境搭建</h2><p>struts2包下载地址：<a href="http://archive.apache.org/dist/struts/binaries/struts-2.0.8-all.zip" target="_blank" rel="noopener">http://archive.apache.org/dist/struts/binaries/struts-2.0.8-all.zip</a></p>
<p>搭建平台： MacOS Mojave 10.14.5<br>使用工具： IntelliJ IDEA<br>Tomcat版本：Apache Tomcat 8.5.16 - MxSrvs自带</p>
<p>首先New一个Project<br><img src="/S2-001 调试日记.resources/6FA2BAFC-BE8C-4740-B028-5642E9A3EAA8.png" alt="ddca0c177f31ccb51326857cc63de34e"></p>
<p>将需要的jar包放入/WEB-INF/lib目录下<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">commons-logging-1.0.4.jar</span><br><span class="line">freemarker-2.3.8.jar</span><br><span class="line">ognl-2.6.11.jar</span><br><span class="line">struts2-core-2.0.8.jar</span><br><span class="line">xwork-2.0.3.jar</span><br></pre></td></tr></table></figure></p>
<p><img src="/S2-001 调试日记.resources/C8DBD68B-81B6-4C2D-BBCD-6F87BEEF1CB8.png" alt="19046de56e4a9f83e5eeee434f3ef471"></p>
<p>创建index.jsp文件<br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">&lt;%@ page language=<span class="string">"java"</span> contentType=<span class="string">"text/html; charset=UTF-8"</span></span><br><span class="line">         pageEncoding=<span class="string">"UTF-8"</span>%&gt;</span><br><span class="line">&lt;%@ taglib prefix=<span class="string">"s"</span> uri=<span class="string">"/struts-tags"</span> %&gt;</span><br><span class="line">&lt;!DOCTYPE html PUBLIC <span class="string">"-//W3C//DTD HTML 4.01 Transitional//EN"</span> <span class="string">"http://www.w3.org/TR/html4/loose.dtd"</span>&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">  &lt;meta http-equiv=<span class="string">"Content-Type"</span> content=<span class="string">"text/html; charset=UTF-8"</span>&gt;</span><br><span class="line">  &lt;title&gt;S2-001&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;h2&gt;S2-001 Demo&lt;/h2&gt;</span><br><span class="line">&lt;p&gt;link: &lt;a href=<span class="string">"https://cwiki.apache.org/confluence/display/WW/S2-001"</span>&gt;https:<span class="comment">//cwiki.apache.org/confluence/display/WW/S2-001&lt;/a&gt;&lt;/p&gt;</span></span><br><span class="line">&lt;s:form action=<span class="string">"login"</span>&gt;</span><br><span class="line">  &lt;s:textfield name=<span class="string">"username"</span> label=<span class="string">"username"</span> /&gt;</span><br><span class="line">  &lt;s:textfield name=<span class="string">"password"</span> label=<span class="string">"password"</span> /&gt;</span><br><span class="line">  &lt;s:submit&gt;&lt;/s:submit&gt;</span><br><span class="line">&lt;/s:form&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure></p>
<p>创建welcome.jsp文件<br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&lt;%@ page language=<span class="string">"java"</span> contentType=<span class="string">"text/html; charset=UTF-8"</span></span><br><span class="line">         pageEncoding=<span class="string">"UTF-8"</span>%&gt;</span><br><span class="line">&lt;%@ taglib prefix=<span class="string">"s"</span> uri=<span class="string">"/struts-tags"</span> %&gt;</span><br><span class="line">&lt;!DOCTYPE html PUBLIC <span class="string">"-//W3C//DTD HTML 4.01 Transitional//EN"</span> <span class="string">"http://www.w3.org/TR/html4/loose.dtd"</span>&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;meta http-equiv=<span class="string">"Content-Type"</span> content=<span class="string">"text/html; charset=UTF-8"</span>&gt;</span><br><span class="line">    &lt;title&gt;S2-001&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;p&gt;Hello &lt;s:property value="username"&gt;&lt;/s:property&gt;&lt;/p&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure></p>
<p>在src目录下创建Package <code>com.demo.action</code><br>然后创建class<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.demo.action;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.opensymphony.xwork2.ActionSupport;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LoginAction</span> <span class="keyword">extends</span> <span class="title">ActionSupport</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String username = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">private</span> String password = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getUsername</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.username;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getPassword</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.password;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUsername</span><span class="params">(String username)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.username = username;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setPassword</span><span class="params">(String password)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.password = password;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">execute</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> ((<span class="keyword">this</span>.username.isEmpty()) || (<span class="keyword">this</span>.password.isEmpty())) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"error"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> ((<span class="keyword">this</span>.username.equalsIgnoreCase(<span class="string">"admin"</span>))</span><br><span class="line">                &amp;&amp; (<span class="keyword">this</span>.password.equals(<span class="string">"admin"</span>))) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"success"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"error"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>导入包<br>File-&gt;Project Structure<br><img src="/S2-001 调试日记.resources/AE8F8103-1317-4E1B-9954-D16381A8BEA7.png" alt="c2721572cd14b75b50bd62cccab3e8dd"><br><img src="/S2-001 调试日记.resources/B172D40B-5AF0-4C93-A59F-C2653B0024D9.png" alt="21aff5f519ea4ea23e7ee17e32e7dfaa"></p>
<p>然后设置好tomcat配置就可以Run了<br><img src="/S2-001 调试日记.resources/0D2C780D-825D-43A0-A5F6-D66B0862F51B.png" alt="c9de8ac5327705aa2b9825e2f5e0786a"></p>
<p><img src="/S2-001 调试日记.resources/37A62E68-1AF0-4309-87FC-DE26FBFC1A36.png" alt="e5e2c3d3929818faaf2e41f45264a79d"></p>
<p>如果遇到<code>java.lang.IllegalStateException: struts.properties missing</code>的问题<br>检查一下自己创建的包名或者类名是否与<code>struts.xml</code>中配置的一致</p>
<p>漏洞环境就已经搭好了</p>
<h2 id="0x03-OGNL表达式"><a href="#0x03-OGNL表达式" class="headerlink" title="0x03 OGNL表达式"></a>0x03 OGNL表达式</h2><h3 id="基本概念"><a href="#基本概念" class="headerlink" title="基本概念"></a>基本概念</h3><blockquote>
<p>OGNL是Object-Graph Navigation Language的缩写，它是一种功能强大的表达式语言（Expression Language，简称为EL），通过它简单一致的表达式语法，可以存取对象的任意属性，调用对象的方法，遍历整个对象的结构图，实现字段类型转化等功能。它使用相同的表达式去存取对象的属性。　　　　　　　　　　　　　　　　——-百度百科</p>
</blockquote>
<p>OGNL的三要素：</p>
<p>　　一、表达式：</p>
<p>　　　　表达式（Expression）是整个OGNL的核心内容，所有的OGNL操作都是针对表达式解析后进行的。通过表达式来告诉OGNL操作到底要干些什么。因此，表达式其实是一个带有语法含义的字符串，整个字符串将规定操作的类型和内容。OGNL表达式支持大量的表达式，如“链式访问对象”、表达式计算、甚至还支持Lambda表达式。</p>
<p>　　二、Root对象：</p>
<p>　　　　OGNL的Root对象可以理解为OGNL的操作对象。当我们指定了一个表达式的时候，我们需要指定这个表达式针对的是哪个具体的对象。而这个具体的对象就是Root对象，这就意味着，如果有一个OGNL表达式，那么我们需要针对Root对象来进行OGNL表达式的计算并且返回结果。</p>
<p>　　三、上下文环境：</p>
<p>　　　　有个Root对象和表达式，我们就可以使用OGNL进行简单的操作了，如对Root对象的赋值与取值操作。但是，实际上在OGNL的内部，所有的操作都会在一个特定的数据环境中运行。这个数据环境就是上下文环境（Context）。OGNL的上下文环境是一个Map结构，称之为OgnlContext。Root对象也会被添加到上下文环境当中去。</p>
<h3 id="Ognl表达式语言的作用"><a href="#Ognl表达式语言的作用" class="headerlink" title="Ognl表达式语言的作用"></a>Ognl表达式语言的作用</h3><p>jsp页面取值用<br>EL表达式语言，也用于页面取值，是jsp页面取值的标准（默认就可以使用）<br>Ognl表达式语言，Struts标签默认支持的表达式语言，必须配置Struts标签用，不能离开Struts标签直接使用，就是说Ognl必须在Struts中使用<br>对比来看，EL使用范围更广，项目中不限制使用哪一种，哪一种熟悉就使用哪一种</p>
<h3 id="OGNL-的基本语法"><a href="#OGNL-的基本语法" class="headerlink" title="OGNL 的基本语法"></a>OGNL 的基本语法</h3><ol>
<li><p>对Root对象的访问<br>OGNL使用的是一种链式的风格进行对象的访问</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">User user = <span class="keyword">new</span> User(<span class="string">"rcx"</span>, <span class="string">"123"</span>);</span><br><span class="line">System.out.println(Ognl.getValue(<span class="string">"name"</span>, user));</span><br></pre></td></tr></table></figure>
</li>
<li><p>对上下文对象的访问<br>使用OGNL的时候如果不设置上下文对象，系统会自动创建一个上下文对象，如果传入的参数当中包含了上下文对象则会使用传入的上下文对象。当访问上下文环境当中的参数时候，需要在表达式前面加上’#’，表示了与访问Root对象的区别</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">User user = <span class="keyword">new</span> User(<span class="string">"rcx"</span>, <span class="string">"123"</span>);</span><br><span class="line">Map&lt;String, Object&gt; context = <span class="keyword">new</span> HashMap&lt;String, Object&gt;();</span><br><span class="line">context.put(<span class="string">"user"</span>, user);</span><br><span class="line">System.out.println(Ognl.getValue(<span class="string">"#user.name"</span>, context, user));</span><br></pre></td></tr></table></figure>
</li>
<li><p>对静态变量的访问<br>在OGNL表达式当中也可以访问静态变量或者调用静态方法，格式如@[class]@[field/method()]。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Object object = Ognl.getValue(<span class="string">"@com.rcx.ognl.Constant@ONE"</span>, <span class="keyword">null</span>);</span><br><span class="line">System.out.println(object);</span><br></pre></td></tr></table></figure>
</li>
<li><p>方法的调用<br>如果需要调用Root对象或者上下文对象当中的方法也可以使用.+方法的方式来调用。甚至可以传入参数。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">User user = <span class="keyword">new</span> User();</span><br><span class="line">Map&lt;String, Object&gt; context = <span class="keyword">new</span> HashMap&lt;String, Object&gt;();</span><br><span class="line">context.put(<span class="string">"name"</span>, <span class="string">"rcx"</span>);</span><br><span class="line">context.put(<span class="string">"password"</span>, <span class="string">"password"</span>);</span><br><span class="line"></span><br><span class="line">System.out.println(Ognl.getValue(<span class="string">"getName()"</span>, context, user));</span><br><span class="line">Ognl.getValue(<span class="string">"setName(#name)"</span>, context, user);</span><br><span class="line">System.out.println(Ognl.getValue(<span class="string">"getName()"</span>, context, user));</span><br></pre></td></tr></table></figure>
</li>
<li><p>对数组和集合的访问<br>OGNL支持对数组按照数组下标的顺序进行访问。此方式也适用于对集合的访问，对于Map支持使用键进行访问</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">User user = <span class="keyword">new</span> User();</span><br><span class="line">Map&lt;String, Object&gt; context = <span class="keyword">new</span> HashMap&lt;String, Object&gt;();</span><br><span class="line">String[] strings  = &#123;<span class="string">"aa"</span>, <span class="string">"bb"</span>&#125;;</span><br><span class="line">ArrayList&lt;String&gt; list = <span class="keyword">new</span> ArrayList&lt;String&gt;();</span><br><span class="line">list.add(<span class="string">"aa"</span>);</span><br><span class="line">list.add(<span class="string">"bb"</span>);</span><br><span class="line">Map&lt;String, String&gt; map = <span class="keyword">new</span> HashMap&lt;String, String&gt;();</span><br><span class="line">map.put(<span class="string">"key1"</span>, <span class="string">"value1"</span>);</span><br><span class="line">map.put(<span class="string">"key2"</span>, <span class="string">"value2"</span>);</span><br><span class="line">context.put(<span class="string">"list"</span>, list);</span><br><span class="line">context.put(<span class="string">"strings"</span>, strings);</span><br><span class="line">context.put(<span class="string">"map"</span>, map);</span><br><span class="line"><span class="keyword">try</span></span><br><span class="line">&#123;</span><br><span class="line">    System.out.println(Ognl.getValue(<span class="string">"#strings[0]"</span>, context, user));</span><br><span class="line">    System.out.println(Ognl.getValue(<span class="string">"#list[0]"</span>, context, user));</span><br><span class="line">    System.out.println(Ognl.getValue(<span class="string">"#list[0 + 1]"</span>, context, user));</span><br><span class="line">    System.out.println(Ognl.getValue(<span class="string">"#map['key1']"</span>, context, user));</span><br><span class="line">    System.out.println(Ognl.getValue(<span class="string">"#map['key' + '2']"</span>, context, user));</span><br><span class="line">    &#125; ...</span><br></pre></td></tr></table></figure>
</li>
<li><p>投影与选择<br>OGNL支持类似数据库当中的选择与投影功能。<br>投影：选出集合当中的相同属性组合成一个新的集合。语法为collection.{XXX}，XXX就是集合中每个元素的公共属性。</p>
</li>
</ol>
<p>　　选择：选择就是选择出集合当中符合条件的元素组合成新的集合。语法为collection.{Y XXX}，其中Y是一个选择操作符，XXX是选择用的逻辑表达式。</p>
<p>　　　　选择操作符有3种：</p>
<p>　　　　　　? ：选择满足条件的所有元素</p>
<p>　　　　　　^：选择满足条件的第一个元素</p>
<p>　　　　　　$：选择满足条件的最后一个元素</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Person p1 = <span class="keyword">new</span> Person(<span class="number">1</span>, <span class="string">"name1"</span>);</span><br><span class="line">Map&lt;String, Object&gt; context = <span class="keyword">new</span> HashMap&lt;String, Object&gt;();</span><br><span class="line">ArrayList&lt;Person&gt; list = <span class="keyword">new</span> ArrayList&lt;Person&gt;();</span><br><span class="line">list.add(p1);</span><br><span class="line">context.put(<span class="string">"list"</span>, list);</span><br><span class="line"></span><br><span class="line">ArrayList&lt;Integer&gt; list2 = (ArrayList&lt;Integer&gt;) Ognl.getValue(<span class="string">"#list.&#123;id&#125;"</span>,context,list);</span><br><span class="line">System.out.println(list2);</span><br></pre></td></tr></table></figure>
<ol start="7">
<li>创建对象<br>OGNL支持直接使用表达式来创建对象。主要有三种情况：<br>构造List对象：使用{},中间使用’,’进行分割如{“aa”, “bb”, “cc”}<br>构造Map对象：使用#{}，中间使用’,进行分割键值对，键值对使用’:’区分，如#{“key1” : “value1”, “key2” : “value2”}<br>构造任意对象：直接使用已知的对象的构造方法进行构造。</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Map&lt;String, String&gt; map = (Map&lt;String, String&gt;)Ognl.getValue(<span class="string">"#&#123;'key1':'value1'&#125;"</span>, <span class="keyword">null</span>);</span><br><span class="line">System.out.println(map);</span><br><span class="line">List&lt;String&gt; list = (List&lt;String&gt;)Ognl.getValue(<span class="string">"&#123;'key1','value1'&#125;"</span>, <span class="keyword">null</span>);</span><br><span class="line">System.out.println(list);</span><br><span class="line">Object object = Ognl.getValue(<span class="string">"new java.lang.Object()"</span>, <span class="keyword">null</span>);</span><br><span class="line">System.out.println(object);</span><br></pre></td></tr></table></figure>
<h2 id="0x04-漏洞验证"><a href="#0x04-漏洞验证" class="headerlink" title="0x04 漏洞验证"></a>0x04 漏洞验证</h2><p><img src="/S2-001 调试日记.resources/AE253F90-888E-41D1-90B8-15C4B43015B0.png" alt="173a3723c16631be26264844cdbf62f1"></p>
<p><img src="/S2-001 调试日记.resources/5EEDC8F3-78F4-480C-8DEF-66D5F3A94521.png" alt="d984073fd34482b1ab9fdcbde28db701"></p>
<h2 id="0x05-漏洞分析"><a href="#0x05-漏洞分析" class="headerlink" title="0x05 漏洞分析"></a>0x05 漏洞分析</h2><p><img src="/S2-001 调试日记.resources/6C8B9E07-AF85-49FC-B9C5-C1D818490AB0.jpg" alt="7b8b8f885d3938a55ac1f182230f389b.jpeg"></p>
<p>Tomcat容器处理后，将http请求发送至struts2，然后分两个阶段：</p>
<ul>
<li>第一阶段： St2对请求进行预处理,这个阶段主要是St2和web容器打交道,把http请求封装成java对象.为真正的业务逻辑执行做必要的数据环境和运行环境的准备</li>
<li>第二阶段：XWork,执行具体的业务逻辑.</li>
</ul>
<p>首先来了解一下拦截器</p>
<blockquote>
<p>java里的拦截器是动态拦截Action调用的对象，它提供了一种机制可以使开发者在一个Action执行的前后执行一段代码，也可以在一个Action执行前阻止其执行，同时也提供了一种可以提取Action中可重用部分代码的方式。在AOP中，拦截器用于在某个方法或者字段被访问之前，进行拦截然后再之前或者之后加入某些操作。目前，我们需要掌握的主要是Spring的拦截器，Struts2的拦截器不用深究，知道即可。</p>
</blockquote>
<p><img src="/S2-001 调试日记.resources/87075291-4555-41BC-88CF-2F4F726BA71E.png" alt="48f11e0431d2c25296631c524ecb17dc"><br>在struts.xml里下一个拦截器，然后在struts_defalut.xml里能找到它拦截的class<br><img src="/S2-001 调试日记.resources/8AD9EB5A-5743-4E42-84F8-724D6D50F987.png" alt="6244e2c9092e27087d80960fd067f86c"></p>
<p><img src="/S2-001 调试日记.resources/1B116D26-D461-4173-B2AA-A4639BF3C65A.png" alt="11ae2cbbc91813e4be305fcd62fcd2f7"><br>第87行、把传入的参数打入到值栈中,我们在这里下断点<br><img src="/S2-001 调试日记.resources/0B9C052A-FBA3-402E-B441-377BC06BEC9E.png" alt="210a7716d4e72acc34ea0c9e4debb639"><br>继续往下，97行，带入到invocation.invoke()</p>
<p><img src="/S2-001 调试日记.resources/0F272921-D58B-457B-B0FE-03FE1E447BF7.png" alt="c95f5460a33e0a3cce226cb863a704fe"><br>继续跟<br><img src="/S2-001 调试日记.resources/C12A6394-C3E3-4591-8B72-DFEC418B2836.png" alt="40d89332841b0919edbc30728ba0dff4"><br>步入<code>executeResult()</code></p>
<p>然后步入<code>dispatcher.forward()</code></p>
<p><img src="/S2-001 调试日记.resources/D0D7AEDE-9400-4D4F-B636-DCF8B2E2FE9D.png" alt="4d1c0453520932caa0527b00105e2931"><br>调试到这里又到了index.jsp<br>然后就是在<code>org.apache.struts2.views.jsp.ComponentTagSupport</code>解析标签<br><img src="/S2-001 调试日记.resources/489250AB-D028-46B8-93EE-E7652452F06B.png" alt="83ab3028a4d3ce9e570b2dd77b6c06d4"><br>然后步入<code>evaluateParams()</code><br><img src="/S2-001 调试日记.resources/B66173B9-1004-4877-B90C-52ED6488D814.png" alt="148f0c15f9f6c13af04ed5bcf3357e66"><br>继续执行到altSyntax(),这个方法返回true,根据<a href="https://cwiki.apache.org/confluence/display/WW/Alt+Syntax" target="_blank" rel="noopener">https://cwiki.apache.org/confluence/display/WW/Alt+Syntax</a><br>,altSyntax默认开启,为了动态的改变标签属性的值,它允许执行标签属性中的OGNL表达式.</p>
<p>同时,为了不过多的引入单引号,可以使用”%{…}”的形式来写入表达式.</p>
<p>此后o为%{1+1}，再对o进行了一番处理后，payload经过result变量，最终成为expression的值：<br><img src="/S2-001 调试日记.resources/38069271-2D08-4E46-AF70-5D74F1CA6BF2.png" alt="f079a36c37e194f8835ce649747acfae"></p>
<p><img src="/S2-001 调试日记.resources/1EF4E0C0-D0AD-47E9-B2D6-28F1583690EB.png" alt="2e1134a2480a0576252c8bffc59beea3"><br><img src="/S2-001 调试日记.resources/96B54A5E-7312-40B9-A2D6-0DEF9D868B6E.png" alt="29bb80f0510fa9b3c240536a175a3c7b"><br>最后<code>Object o = stack.findValue(var, asType);</code>执行payload<br><img src="/S2-001 调试日记.resources/F61303FA-6893-40A5-A62B-492EC506AE7C.png" alt="69e61401ac66f42f5b7f17f42870d541"></p>
<h2 id="0x06-总结"><a href="#0x06-总结" class="headerlink" title="0x06 总结"></a>0x06 总结</h2><p>其实这个漏洞还是挺简单的，写的很乱，但是确实是跟着几篇文章一步一步自己跳出来的，也算是第一个调的java漏洞了，学到很多调试技巧，膜一下chybeta师傅..</p>
<h2 id="0x07-链接"><a href="#0x07-链接" class="headerlink" title="0x07 链接"></a>0x07 链接</h2><p><a href="https://03i0.com/2018/04/08/S2-001%E8%B0%83%E8%AF%95%E5%88%86%E6%9E%90/" target="_blank" rel="noopener">https://03i0.com/2018/04/08/S2-001%E8%B0%83%E8%AF%95%E5%88%86%E6%9E%90/</a></p>
<p><a href="https://www.kingkk.com/2018/08/%E4%BB%8E%E9%9B%B6%E5%BC%80%E5%A7%8B%E5%AD%A6%E4%B9%A0struts2-S2-001/#%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8" target="_blank" rel="noopener">https://www.kingkk.com/2018/08/%E4%BB%8E%E9%9B%B6%E5%BC%80%E5%A7%8B%E5%AD%A6%E4%B9%A0struts2-S2-001/#%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8</a></p>
<p><a href="https://xz.aliyun.com/t/2044" target="_blank" rel="noopener">https://xz.aliyun.com/t/2044</a></p>
</div><div class="tags"><a href="/tags/Struts2/">Struts2</a></div><div class="post-nav"><a class="pre" href="/2019/08/15/从Learn Git Branching学习Git/">从Learn Git Branching学习Git</a><a class="next" href="/2019/08/14/初识威胁情报/">初识威胁情报</a></div><div id="disqus_thread"><div class="btn_click_load"><button class="disqus_click_btn">阅读评论（请确保 Disqus 可以正常加载）</button></div><script type="text/javascript">var disqus_config = function () {
    this.page.url = 'http://patrilic.top/2019/08/15/S2-001 调试日记/';
    this.page.identifier = '2019/08/15/S2-001 调试日记/';
    this.page.title = 'S2-001 调试日记';
  };</script><script type="text/javascript" id="disqus-lazy-load-script">$.ajax({
url: 'https://disqus.com/next/config.json',
timeout: 2500,
type: 'GET',
success: function(){
  var d = document;
  var s = d.createElement('script');
  s.src = '//Patrilic.disqus.com/embed.js';
  s.setAttribute('data-timestamp', + new Date());
  (d.head || d.body).appendChild(s);
  $('.disqus_click_btn').css('display', 'none');
},
error: function() {
  $('.disqus_click_btn').css('display', 'block');
}
});</script><script type="text/javascript" id="disqus-click-load">$('.btn_click_load').click(() => {  //click to load comments
    (() => { // DON'T EDIT BELOW THIS LINE
        var d = document;
        var s = d.createElement('script');
        s.src = '//Patrilic.disqus.com/embed.js';
        s.setAttribute('data-timestamp', + new Date());
        (d.head || d.body).appendChild(s);
    })();
    $('.disqus_click_btn').css('display','none');
});</script><script type="text/javascript" id="disqus-count-script">$(function() {
     var xhr = new XMLHttpRequest();
     xhr.open('GET', '//disqus.com/next/config.json', true);
     xhr.timeout = 2500;
     xhr.onreadystatechange = function () {
       if (xhr.readyState === 4 && xhr.status === 200) {
         $('.post-meta .post-comments-count').show();
         var s = document.createElement('script');
         s.id = 'dsq-count-scr';
         s.src = 'https://Patrilic.disqus.com/count.js';
         s.async = true;
         (document.head || document.body).appendChild(s);
       }
     };
     xhr.ontimeout = function () { xhr.abort(); };
     xhr.send(null);
   });
</script></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form class="search-form" action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank"><input type="text" name="q" maxlength="20" placeholder="Search"><input type="hidden" name="sitesearch" value="http://patrilic.top"></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/ATT-CK/">ATT&CK</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/BypassUac/">BypassUac</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Diary/">Diary</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Pentest-Cheat-Sheet/">Pentest Cheat Sheet</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Red-Team-Tricks/">Red-Team Tricks</a><span class="category-list-count">7</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/SQLi-Tricks/">SQLi Tricks</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Skills/">Skills</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Threat-Intelligence/">Threat Intelligence</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Write-up/">Write-up</a><span class="category-list-count">8</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/linux/">linux</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/漏洞复现/">漏洞复现</a><span class="category-list-count">8</span></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/metasploit/" style="font-size: 15px;">metasploit</a> <a href="/tags/Backdoor/" style="font-size: 15px;">Backdoor</a> <a href="/tags/Bypass-CDN/" style="font-size: 15px;">Bypass CDN</a> <a href="/tags/BlueKeep/" style="font-size: 15px;">BlueKeep</a> <a href="/tags/Windows提权/" style="font-size: 15px;">Windows提权</a> <a href="/tags/Forcepoint-VPN/" style="font-size: 15px;">Forcepoint VPN</a> <a href="/tags/DLL-Hijacking/" style="font-size: 15px;">DLL Hijacking</a> <a href="/tags/代码审计/" style="font-size: 15px;">代码审计</a> <a href="/tags/n1ctf-pentest/" style="font-size: 15px;">n1ctf-pentest</a> <a href="/tags/CTF/" style="font-size: 15px;">CTF</a> <a href="/tags/内网渗透/" style="font-size: 15px;">内网渗透</a> <a href="/tags/proc/" style="font-size: 15px;">proc</a> <a href="/tags/SQL注入/" style="font-size: 15px;">SQL注入</a> <a href="/tags/Struts2/" style="font-size: 15px;">Struts2</a> <a href="/tags/文件上传/" style="font-size: 15px;">文件上传</a> <a href="/tags/Git/" style="font-size: 15px;">Git</a> <a href="/tags/威胁情报/" style="font-size: 15px;">威胁情报</a> <a href="/tags/命令执行/" style="font-size: 15px;">命令执行</a> <a href="/tags/iSoonLab-org/" style="font-size: 15px;">iSoonLab.org</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="https://balis0ng.com" title="balis0ng" target="_blank">balis0ng</a><ul></ul><a href="https://evi1cg.me/" title="evi1cg's Blog" target="_blank">evi1cg's Blog</a><ul></ul><a href="http://hpdoger.cn" title="Hpdoger" target="_blank">Hpdoger</a><ul></ul><a href="http://0day.design" title="Passer6y" target="_blank">Passer6y</a><ul></ul><a href="http://adm1n.design" title="Hu3sky" target="_blank">Hu3sky</a><ul></ul><a href="http://0xa1paca.top" title="0xa1paca" target="_blank">0xa1paca</a><ul></ul><a href="http://noel.xin/" title="Noel's Blog" target="_blank">Noel's Blog</a><ul></ul><a href="https://www.0akarma.com" title="0aKarmA" target="_blank">0aKarmA</a><ul></ul><a href="https://www.cnblogs.com/H4lo" title="H4lo" target="_blank">H4lo</a><ul></ul><a href="https://www.kingkk.com/" title="Kingkk's Blog" target="_blank">Kingkk's Blog</a><ul></ul><a href="http://blog.leanote.com/snowming" title="Snowming" target="_blank">Snowming</a><ul></ul><a href="http://r3start.net/" title="R3start" target="_blank">R3start</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2019 <a href="/." rel="nofollow">Patrilic's blog.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","model":{"jsonPath":"/live2dw/assets/koharu.model.json"},"display":{"position":"right","width":150,"height":300},"mobile":{"show":true},"log":false,"tagMode":false});</script></body></html>